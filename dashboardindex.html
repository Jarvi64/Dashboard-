<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprehensive Spend Dashboard (ECharts) - Date Filter</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/map/js/world.js"></script>
    <style>
        /* --- CSS (Keep exact same CSS as the previous working version) --- */
        :root { /* Color variables */
            --header-bg: #2c3e50; --accent-color: #f39c12; --card-bg: #ecf0f1; --kpi-border-1: #3498db;
            --kpi-border-2: #9b59b6; --text-dark: #333; --text-light: #555; --border-color: #ddd;
            --bg-light: #f4f4f4; --bg-white: #fff; --danger-color: #e74c3c; --danger-hover: #c0392b;
            --warning-bg: #fffbe6; --warning-border: #ffe58f; --warning-text: #d46b08;
        }
        html { scroll-behavior: smooth; }
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: var(--bg-light); color: var(--text-dark); font-size: 14px; line-height: 1.5; }
        .dashboard-container { display: flex; flex-direction: column; min-height: 100vh; }
        .dashboard-header { background-color: var(--header-bg); color: var(--bg-white); padding: 12px 15px; text-align: center; border-bottom: 3px solid var(--accent-color); }
        .dashboard-header h1 { margin: 0; font-size: 1.4em; }
        .dashboard-content { display: flex; flex-direction: column; flex: 1; padding: 10px; gap: 15px; }
        .sidebar { width: 100%; background-color: var(--bg-white); padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); box-sizing: border-box; }
        .sidebar h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; color: var(--header-bg); border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .filter-info, .error-message { font-size: 0.9em; margin-bottom: 15px; padding: 8px; border-radius: 3px; border: 1px solid var(--border-color); min-height: 2.5em; word-wrap: break-word; }
        .filter-info { background-color: #eef; }
        .error-message { background-color: var(--warning-bg); border-color: var(--warning-border); color: var(--warning-text); font-weight: bold; display: none; }
        .reset-button { display: block; width: 100%; padding: 10px; background-color: var(--danger-color); color: white; border: none; border-radius: 4px; font-size: 1em; cursor: pointer; transition: background-color 0.2s; margin-top: 10px; }
        .reset-button:hover { background-color: var(--danger-hover); }
        .slicer label { display: block; font-weight: bold; margin-bottom: 3px; font-size: 0.9em; }
        .slicer select, .slicer input[type="date"], .slicer input[type="text"] { width: 100%; padding: 8px; font-size: 0.9em; margin-bottom: 10px; border: 1px solid var(--border-color); border-radius: 3px; box-sizing: border-box; }
        .date-range-label { margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;} /* Style for date label */
        .date-input-group { display: flex; gap: 5px; align-items: center; } /* Layout for date inputs */
        .date-input-group label { flex-basis: 30px; text-align: right; margin-bottom: 0; font-size: 0.85em;}

        .main-content { width: 100%; display: flex; flex-direction: column; gap: 15px; }
        .dashboard-page { background-color: var(--bg-white); padding: 15px; border-radius: 5px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .page-title { font-size: 1.25em; color: var(--accent-color); margin: 0 0 15px 0; border-bottom: 2px solid #eee; padding-bottom: 8px; }
        .kpi-container { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; }
        .kpi-card { background-color: var(--card-bg); padding: 12px; border-radius: 5px; text-align: center; flex: 1 1 120px; border-left: 4px solid var(--kpi-border-1); min-width: 120px; }
        .kpi-card.alt-color { border-left-color: var(--kpi-border-2); }
        .kpi-card .value { font-size: 1.4em; font-weight: bold; color: var(--header-bg); display: block; }
        .kpi-card .label { font-size: 0.8em; color: var(--text-light); margin-top: 3px; display: block; }
        .visual-row { display: flex; flex-direction: column; gap: 15px; margin-bottom: 15px; }
        .visual-container { background-color: #fdfdfd; border: 1px solid #eee; padding: 10px; border-radius: 4px; width: 100%; box-sizing: border-box; display: flex; flex-direction: column; }
        .visual-container h4 { margin: 0 0 10px 0; font-size: 1em; text-align: center; flex-shrink: 0; color: var(--text-dark); }
        .chart-container { width: 100%; height: 300px; min-height: 280px; flex-grow: 1; }
        .chart-container-tall { height: 380px; } .chart-container-xl { height: 450px; } .chart-container-short { height: 250px; }
        .chart-placeholder { display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-light); font-style: italic; background-color: #fafafa; border: 1px dashed var(--border-color); text-align: center;}
        .table-container { width: 100%; overflow-x: auto; max-height: 300px; border: 1px solid var(--border-color); border-radius: 3px; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        th, td { border: 1px solid var(--border-color); padding: 6px 8px; text-align: left; white-space: nowrap; }
        th { background-color: var(--card-bg); font-weight: bold; color: var(--header-bg); position: sticky; top: 0; z-index: 1; }
        tbody tr:nth-child(even) { background-color: #f9f9f9; } tbody tr:hover { background-color: #f1c40f30; cursor: pointer; } tbody tr.filtered { background-color: #aed6f1 !important; font-weight: bold; }
        td:nth-child(n+2):not(:first-child) { text-align: right; }
        .footer { text-align: center; padding: 10px; margin-top: 15px; font-size: 0.75em; color: var(--text-light); border-top: 1px solid #eee; }
        @media (min-width: 768px) { /* Styles for tablets and larger */
             body { font-size: 15px; } .dashboard-header h1 { font-size: 1.6em; } .dashboard-content { flex-direction: row; padding: 15px; } .sidebar { width: 240px; flex-shrink: 0; } .main-content { flex: 1; } .kpi-card { padding: 15px; flex-basis: 150px; } .kpi-card .value { font-size: 1.7em; } .kpi-card .label { font-size: 0.9em; } .visual-row { flex-direction: row; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; } .visual-container { flex: 1 1 45%; min-width: 350px; } .visual-container.full-width { flex-basis: 100%; min-width: calc(100% - 30px); } .chart-container { height: 350px; } .chart-container-tall { height: 420px; } .chart-container-xl { height: 500px; } .chart-container-short { height: 280px; } .table-container { max-height: 340px; } table { font-size: 0.9em; }
        }
        @media (min-width: 1200px) { /* Large screens */
             .kpi-card { flex-basis: 160px; } .visual-container { min-width: 400px; } .chart-container { height: 380px; } .chart-container-tall { height: 450px; } .chart-container-xl { height: 550px; }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <h1>Comprehensive Spend Dashboard</h1>
        </header>

        <div class="dashboard-content">
            <aside class="sidebar">
                <h3>Filters</h3>
                <div id="filter-info" class="filter-info">Initializing...</div>
                <div id="error-message" class="error-message"></div>

                <!-- Date Range Slicer -->
                <div class="slicer">
                    <label class="date-range-label">Posting Date Range:</label>
                    <div class="date-input-group">
                         <label for="date-start">From:</label>
                         <input type="date" id="date-start" name="date-start">
                    </div>
                     <div class="date-input-group">
                         <label for="date-end">To:</label>
                         <input type="date" id="date-end" name="date-end">
                    </div>
                </div>

                <!-- Existing disabled slicers -->
                 <div style="margin-top: 20px; padding-top:15px; border-top: 1px solid #eee;" class="slicer">
                     <label>Company Code:</label><select disabled><option>(All)</option></select>
                 </div>

                 <button id="reset-filters" class="reset-button">Reset All Filters</button>

            </aside>

            <main class="main-content">
                <!-- Dashboard sections remain the same -->
                <section class="dashboard-page" id="main-dashboard">
                    <h2 class="page-title">Spend Overview & Time Analysis</h2>
                    <div class="kpi-container">
                        <div class="kpi-card"><div class="value" id="kpi-total-spend">$0</div><div class="label">Total Spend</div></div>
                        <div class="kpi-card alt-color"><div class="value" id="kpi-total-pos">0</div><div class="label">Total POs</div></div>
                        <div class="kpi-card"><div class="value" id="kpi-total-invoices">0</div><div class="label">Total Invoices</div></div>
                        <div class="kpi-card alt-color"><div class="value" id="kpi-active-vendors">0</div><div class="label">Active Vendors</div></div>
                        <div class="kpi-card"><div class="value" id="kpi-avg-spend-po">$0</div><div class="label">Avg Spend / PO</div></div>
                    </div>

                    <div class="visual-row">
                        <div class="visual-container full-width">
                             <h4>Daily Spend Heatmap (Filtered Range)</h4> <!-- Updated title -->
                             <div id="calendarHeatmapChart" class="chart-container chart-container-tall"><div class="chart-placeholder">Loading Calendar...</div></div>
                        </div>
                    </div>
                     <div class="visual-row">
                         <div class="visual-container">
                            <h4>Spend Trend Over Time (Monthly)</h4>
                            <div id="spendTrendChart" class="chart-container chart-container-short"><div class="chart-placeholder">Loading Trend...</div></div>
                         </div>
                         <div class="visual-container">
                            <h4>Spend by PO Type</h4>
                             <div id="spendByPOTypeChart" class="chart-container chart-container-short"><div class="chart-placeholder">Loading PO Types...</div></div>
                         </div>
                     </div>

                    <h2 class="page-title" style="margin-top: 30px;">Category & Vendor Analysis</h2>
                     <div class="visual-row">
                        <div class="visual-container">
                            <h4>Top 10 Vendors by Spend</h4>
                            <div id="topVendorsChart" class="chart-container"><div class="chart-placeholder">Loading Vendors...</div></div>
                        </div>
                         <div class="visual-container">
                             <h4>Spend by Category (Treemap)</h4>
                             <div id="categoryTreemapChart" class="chart-container"><div class="chart-placeholder">Loading Categories...</div></div>
                        </div>
                    </div>
                    <div class="visual-row">
                         <div class="visual-container">
                             <h4>Detailed Vendor Ranking</h4>
                             <div class="table-container">
                                <table id="vendor-ranking-table">
                                    <thead><tr><th>Vendor</th><th>Country</th><th>Spend</th><th># POs</th><th>Avg Spend/PO</th></tr></thead>
                                    <tbody id="vendor-ranking-tbody"><tr><td colspan="5">Loading data...</td></tr></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="visual-container">
                            <h4>Top Category Comparison (Radar)</h4>
                             <div id="categoryRadarChart" class="chart-container"><div class="chart-placeholder">Loading Radar...</div></div>
                         </div>
                    </div>
                    <div class="visual-row">
                         <div class="visual-container">
                            <h4>Spend Hierarchy: Category -> Vendor (Sunburst)</h4>
                             <div id="categoryVendorSunburst" class="chart-container chart-container-tall"><div class="chart-placeholder">Loading Sunburst...</div></div>
                         </div>
                         <div class="visual-container">
                            <h4>Spend Flow: Category -> Vendor (Sankey)</h4>
                             <div id="categoryVendorSankey" class="chart-container chart-container-tall"><div class="chart-placeholder">Loading Sankey...</div></div>
                         </div>
                    </div>

                     <h2 class="page-title" style="margin-top: 30px;">Geographic Analysis</h2>
                      <div class="visual-row">
                         <div class="visual-container full-width">
                            <h4>Spend by Vendor Country (Geo Map)</h4>
                             <div id="spendGeoMapChart" class="chart-container chart-container-xl"><div class="chart-placeholder" id="map-placeholder">Loading Map...</div></div>
                         </div>
                     </div>

                </section>
            </main>
        </div>
        <footer class="footer">Comprehensive ECharts Demo | Data is simulated | Map data from ECharts/Natural Earth</footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Loaded. Initializing Dashboard...");
            const domElements = { /* Get DOM elements */
                 kpiTotalSpend: document.getElementById('kpi-total-spend'), kpiTotalPOs: document.getElementById('kpi-total-pos'), kpiTotalInvoices: document.getElementById('kpi-total-invoices'), kpiActiveVendors: document.getElementById('kpi-active-vendors'), kpiAvgSpendPO: document.getElementById('kpi-avg-spend-po'), vendorRankingTbody: document.getElementById('vendor-ranking-tbody'), filterInfoDiv: document.getElementById('filter-info'), resetButton: document.getElementById('reset-filters'), errorMessageDiv: document.getElementById('error-message'), mapPlaceholder: document.getElementById('map-placeholder'),
                 // ** NEW: Get date inputs **
                 dateStartInput: document.getElementById('date-start'),
                 dateEndInput: document.getElementById('date-end')
                 // *************************
            };
             if (Object.values(domElements).some(el => !el)) { console.error("Essential UI elements not found!"); alert("Dashboard UI is incomplete."); return; }

            function displayError(message, error = null) { /* ... same ... */ console.error(message, error || ''); domElements.errorMessageDiv.textContent = `⚠️ Error: ${message}. Check console.`; domElements.errorMessageDiv.style.display = 'block'; }
            function clearError() { /* ... same ... */ domElements.errorMessageDiv.style.display = 'none'; domElements.errorMessageDiv.textContent = ''; }
            function clearChartPlaceholders() { document.querySelectorAll('.chart-placeholder').forEach(el => el.style.display = 'none'); }
            function showMapPlaceholder(message = "Map data not available.") { /* ... same ... */ if (domElements.mapPlaceholder) { domElements.mapPlaceholder.textContent = message; domElements.mapPlaceholder.style.display = 'flex'; } document.querySelectorAll('.chart-placeholder:not(#map-placeholder)').forEach(el => el.style.display = 'none'); }


            // --- 1. Mock Data Generation ---
            let rawData = [];
            let minDataDate = null, maxDataDate = null; // To store actual data range
            const endDate = new Date(); const startDate = new Date(); startDate.setDate(endDate.getDate() - 365);
            const vendors = ['Alpha Tech', 'Beta Ind Parts', 'Gamma Services', 'Delta Components', 'Epsilon Logistics', 'Zeta Supplies', 'Eta Consulting', 'Theta Hardware', 'Iota Raw Materials', 'Kappa MRO', 'Lambda Software', 'Mu Facilities Mgmt', 'Nu Marketing Agency', 'Xi Chemicals'];
            const categories = ['IT Hardware', 'Raw Materials', 'Consulting Svcs', 'Logistics', 'MRO', 'Software Licences', 'Facilities Maintenance', 'Marketing Spend', 'Travel & Expense', 'Office Supplies', 'Chemical Supplies'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthLookup = { 0: 'Jan', 1: 'Feb', 2: 'Mar', 3: 'Apr', 4: 'May', 5: 'Jun', 6: 'Jul', 7: 'Aug', 8: 'Sep', 9: 'Oct', 10: 'Nov', 11: 'Dec' };
            const poTypes = { 'NB': 'Standard PO', 'FO': 'Service PO', 'LP': 'Contract Release', 'UB': 'Stock Transport' }; const poTypeKeys = Object.keys(poTypes);
            const countries = { 'DE': { name: 'Germany' }, 'US': { name: 'United States' }, 'CN': { name: 'China' }, 'IN': { name: 'India' }, 'GB': { name: 'United Kingdom' }, 'FR': { name: 'France' }, 'JP': { name: 'Japan' }, 'BR': { name: 'Brazil' }, 'CA': { name: 'Canada'}, 'AU': { name: 'Australia'} }; const countryCodes = Object.keys(countries);
            const affinity = { /* ... same ... */ 'IT Hardware': ['Alpha Tech', 'Theta Hardware', 'Delta Components'], 'Raw Materials': ['Iota Raw Materials', 'Beta Ind Parts', 'Xi Chemicals'], 'Consulting Svcs': ['Gamma Services', 'Eta Consulting'], 'Logistics': ['Epsilon Logistics'], 'MRO': ['Kappa MRO', 'Zeta Supplies', 'Beta Ind Parts'], 'Software Licences': ['Lambda Software', 'Alpha Tech'], 'Facilities Maintenance': ['Mu Facilities Mgmt', 'Gamma Services'], 'Marketing Spend': ['Gamma Services', 'Eta Consulting', 'Nu Marketing Agency'], 'Office Supplies': ['Zeta Supplies'], 'Chemical Supplies': ['Xi Chemicals', 'Beta Ind Parts'] };

            try { // Generate Data
                 let recordId = 0; for (let i = 0; i < 1500; i++) {
                    recordId++; const randomTime = startDate.getTime() + Math.random() * (endDate.getTime() - startDate.getTime()); const postingDate = new Date(randomTime); const formattedDate = postingDate.toISOString().split('T')[0]; const monthIndex = postingDate.getMonth(); const monthName = monthLookup[monthIndex]; const poTypeKey = poTypeKeys[Math.floor(Math.random() * poTypeKeys.length)]; let category; const catRand = Math.random(); if (catRand < 0.18) category = 'IT Hardware'; else if (catRand < 0.33) category = 'Raw Materials'; else if (catRand < 0.45) category = 'Consulting Svcs'; else if (catRand < 0.55) category = 'MRO'; else if (catRand < 0.65) category = 'Software Licences'; else if (catRand < 0.75) category = 'Logistics'; else if (catRand < 0.82) category = 'Chemical Supplies'; else category = categories[Math.floor(Math.random() * categories.length)]; let vendor; const vendorPool = affinity[category] || vendors; if (affinity[category] && Math.random() < 0.75) { vendor = vendorPool[Math.floor(Math.random() * vendorPool.length)]; } else { vendor = vendors[Math.floor(Math.random() * vendors.length)]; } const vendorIndex = vendors.indexOf(vendor); const vendorCountryCode = countryCodes[vendorIndex % countryCodes.length]; let spend; const spendRand = Math.random(); if (spendRand < 0.04) spend = Math.floor(Math.random() * 180000) + 60000; else if (spendRand < 0.22) spend = Math.floor(Math.random() * 50000) + 10000; else spend = Math.floor(Math.random() * 10000) + 500;
                    if (vendor && category && formattedDate && monthName && poTypeKey && spend > 0 && vendorCountryCode) {
                        rawData.push({ id: recordId, vendor, vendorCountry: vendorCountryCode, category, postingDate: formattedDate, monthName: monthName, poType: poTypeKey, poTypeDesc: poTypes[poTypeKey], spend, poCount: 1, invoiceCount: Math.random() > 0.08 ? 1 : 0 });
                         // ** NEW: Track min/max dates **
                         if (!minDataDate || formattedDate < minDataDate) minDataDate = formattedDate;
                         if (!maxDataDate || formattedDate > maxDataDate) maxDataDate = formattedDate;
                         // ***************************
                    } else { console.warn("Skipped generating record"); }
                 }
                console.log(`Generated ${rawData.length} records. Date range: ${minDataDate} to ${maxDataDate}`);
                if(rawData.length === 0) throw new Error("FATAL: No raw data generated.");

                 // ** NEW: Set min/max on date inputs **
                 if (minDataDate && maxDataDate) {
                     if (domElements.dateStartInput) domElements.dateStartInput.min = minDataDate;
                     if (domElements.dateStartInput) domElements.dateStartInput.max = maxDataDate; // Can't select start after latest date
                     if (domElements.dateEndInput) domElements.dateEndInput.min = minDataDate; // Can't select end before earliest date
                     if (domElements.dateEndInput) domElements.dateEndInput.max = maxDataDate;
                     console.log(`Set date input range: ${minDataDate} to ${maxDataDate}`);
                 }
                 // **********************************

            } catch (error) { displayError("Failed to generate sample data", error); return; }

            // --- 2. Filter State ---
            let currentFilters = {
                vendor: null,
                category: null,
                poType: null,
                // ** NEW: Add date filters **
                startDate: null,
                endDate: null
                // *************************
            };

            // --- 3. Chart Instances ---
            let chartInstances = {};
            const chartConfigs = [ /* (Keep list) */ { id: 'spendTrendChart'}, { id: 'topVendorsChart'}, { id: 'categoryTreemapChart'}, { id: 'spendByPOTypeChart'}, { id: 'categoryVendorSankey'}, { id: 'calendarHeatmapChart'}, { id: 'categoryRadarChart'}, { id: 'categoryVendorSunburst'}, { id: 'spendGeoMapChart'} ];
            try { // Initialize charts
                 chartConfigs.forEach(config => { const el = document.getElementById(config.id); if (el) { chartInstances[config.id] = echarts.init(el); console.log(`Initialized chart: ${config.id}`); } else { throw new Error(`Chart element not found for: ${config.id}`); } });
            } catch(error) { displayError("Could not initialize charts", error); return; }

            // --- 4. Helper Functions ---
            // Keep formatCurrency, formatNumber, aggregateData, getCountryName, getPOTypeKey as they were
             const formatCurrency = (value, hideDecimalsForLarge = true) => { /* ... */ if (value === 0) return '$0'; if (!value && value !== 0) return '$0'; if (value >= 1000000) { const valM = (value / 1000000); return '$' + (hideDecimalsForLarge ? valM.toFixed(1) : valM.toFixed(2)) + 'M'; } if (value >= 1000) { const valK = (value / 1000); return '$' + (hideDecimalsForLarge ? valK.toFixed(1) : valK.toFixed(2)) + 'k'; } return '$' + value.toFixed(0); };
             const formatNumber = (value) => (value || value === 0) ? value.toLocaleString() : '0';
             const aggregateData = (filteredData, groupBy, sumFields = ['spend', 'poCount', 'invoiceCount']) => { /* ... */ const result = {}; if (!filteredData || filteredData.length === 0) return []; filteredData.forEach(item => { const key = item[groupBy]; if (key === undefined || key === null || key === '') return; if (!result[key]) { result[key] = {}; sumFields.forEach(field => result[key][field] = 0); if (groupBy === 'poType') result[key].poTypeDesc = item.poTypeDesc; if (groupBy === 'vendor') result[key].vendorCountry = item.vendorCountry; } sumFields.forEach(field => { if (typeof item[field] === 'number') result[key][field] += item[field]; }); }); return Object.entries(result).map(([key, value]) => ({ [groupBy]: key, ...value })); };
             const getCountryName = (code) => countries[code] ? countries[code].name : code;
             const getPOTypeKey = (description) => { for (const key in poTypes) { if (poTypes[key] === description) return key; } return null; };

            // --- 5. Update Function ---
            function updateDashboard() {
                 clearError();
                 console.log("Updating dashboard with filters:", JSON.stringify(currentFilters));
                 const startTime = performance.now();

                 try {
                     const filteredData = rawData.filter(item => {
                         const vendorMatch = !currentFilters.vendor || item.vendor === currentFilters.vendor;
                         const categoryMatch = !currentFilters.category || item.category === currentFilters.category;
                         const poTypeMatch = !currentFilters.poType || item.poType === currentFilters.poType;
                         // ** NEW: Date Range Filter Logic **
                         // Compare postingDate string (YYYY-MM-DD) with filter strings
                         const dateMatch = (!currentFilters.startDate || item.postingDate >= currentFilters.startDate) &&
                                           (!currentFilters.endDate || item.postingDate <= currentFilters.endDate);
                         // **********************************
                         return vendorMatch && categoryMatch && poTypeMatch && dateMatch; // Include dateMatch
                     });
                     console.log(`Filtered data count: ${filteredData.length}`);

                     // Calculate aggregated data (using robust functions)
                     const spendByMonthAgg = aggregateData(filteredData, 'monthName');
                     const spendByVendorAgg = aggregateData(filteredData, 'vendor').sort((a, b) => (b.spend || 0) - (a.spend || 0));
                     const spendByCategoryAgg = aggregateData(filteredData, 'category').sort((a, b) => (b.spend || 0) - (a.spend || 0));
                     const spendByPOTypeAgg = aggregateData(filteredData, 'poType');
                     const spendByDateAgg = aggregateData(filteredData, 'postingDate');
                     const spendByCountryAgg = aggregateData(filteredData, 'vendorCountry');

                     // KPIs (using robust functions)
                     const totalSpend = filteredData.reduce((sum, item) => sum + (item.spend || 0), 0);
                     const totalPOs = filteredData.reduce((sum, item) => sum + (item.poCount || 0), 0);
                     const totalInvoices = filteredData.reduce((sum, item) => sum + (item.invoiceCount || 0), 0);
                     const activeVendors = new Set(filteredData.map(item => item.vendor)).size;
                     const avgSpendPO = totalPOs > 0 ? totalSpend / totalPOs : 0;

                     // --- Update ECharts Options ---
                     console.log("Updating chart options...");
                     clearChartPlaceholders();

                     // Calendar Heatmap (Update range based on filter if desired, or show full year)
                     const calendarData = spendByDateAgg.map(d => [d.postingDate, d.spend || 0]);
                     const calendarMaxSpend = calendarData.length > 0 ? Math.max(10000, ...calendarData.map(d => d[1])) : 10000;
                     // ** NEW: Determine calendar range based on filter OR data bounds **
                     const calendarRangeStart = currentFilters.startDate || minDataDate || startDate.toISOString().split('T')[0];
                     const calendarRangeEnd = currentFilters.endDate || maxDataDate || endDate.toISOString().split('T')[0];
                     // ***************************************************************
                     if(chartInstances.calendarHeatmapChart) chartInstances.calendarHeatmapChart.setOption({
                         tooltip: { position: 'top', formatter: (p) => p.data ? `${p.data[0]}: ${formatCurrency(p.data[1])}`: '' },
                         visualMap: { min: 0, max: calendarMaxSpend, calculable: true, orient: 'horizontal', left: 'center', bottom: 10, inRange: { color: ['#e0f3f8', '#abd9e9', '#74add1', '#4575b4', '#313695'].reverse() } },
                         // ** NEW: Use dynamic range **
                         calendar: { range: [calendarRangeStart, calendarRangeEnd],
                         // ****************************
                             cellSize: ['auto', 15], splitLine: { show: true, lineStyle: { color: '#ddd', width: 1, type: 'solid' } }, yearLabel: { show: true, margin: 30 }, dayLabel: { nameMap: 'en', firstDay: 1 }, monthLabel: { nameMap: 'en' }, itemStyle: { color: '#f9f9f9', borderWidth: 1, borderColor: '#eee' } },
                         series: { type: 'heatmap', coordinateSystem: 'calendar', data: calendarData }
                     }, true);

                      // Spend Trend (Data already filtered by date range)
                      const spendTrendDataMap = spendByMonthAgg.reduce((acc, item) => { acc[item.monthName] = item.spend || 0; return acc; }, {});
                      const spendTrendSeriesData = months.map(month => spendTrendDataMap[month] || 0); // Show all months, value is 0 if no data in range
                      if(chartInstances.spendTrendChart) chartInstances.spendTrendChart.setOption({ /* ... */ tooltip: { trigger: 'axis', valueFormatter: (value) => formatCurrency(value) }, xAxis: { type: 'category', data: months }, yAxis: { type: 'value', axisLabel: { formatter: (val) => formatCurrency(val) } }, series: [{ name: 'Spend', type: 'line', smooth: true, data: spendTrendSeriesData, areaStyle: {}, emphasis: { focus: 'series' } }], grid: { left: '15%', right: '5%', bottom: '15%', top: '15%' } }, true);

                      // PO Type Pie (Keep robust mapping)
                       if (chartInstances.spendByPOTypeChart) chartInstances.spendByPOTypeChart.setOption({ /* ... */ tooltip: { trigger: 'item', formatter: '{b}: {c} ({d}%)', valueFormatter: (value) => formatCurrency(value) }, legend: { type: 'scroll', orient: 'vertical', right: 10, top: 20, bottom: 20, data: spendByPOTypeAgg.map(d => d.poTypeDesc || 'Unknown').sort() }, series: [{ name: 'Spend by PO Type', type: 'pie', radius: ['40%', '70%'], center: ['45%', '50%'], avoidLabelOverlap: true, itemStyle: { borderRadius: 5, borderColor: '#fff', borderWidth: 1 }, label: { show: false }, labelLine: { show: false }, data: spendByPOTypeAgg.map(d => ({ name: d.poTypeDesc || 'Unknown', value: d.spend || 0 })).sort((a,b) => b.value - a.value), emphasis: { label: { show: true, fontSize: 14, fontWeight: 'bold' } } }] }, true);

                     // Top Vendors Bar (Keep robust mapping)
                      const topN = 10; const topVendorsData = spendByVendorAgg.slice(0, topN); if (chartInstances.topVendorsChart) chartInstances.topVendorsChart.setOption({ /* ... */ tooltip: { trigger: 'axis', axisPointer: { type: 'shadow' }, valueFormatter: (value) => formatCurrency(value) }, grid: { left: '3%', right: '20%', bottom: '3%', containLabel: true }, xAxis: { type: 'value', axisLabel: { formatter: (val) => formatCurrency(val), rotate: 30 } }, yAxis: { type: 'category', data: topVendorsData.map(v => v.vendor || 'Unknown').reverse() }, series: [{ name: 'Total Spend', type: 'bar', data: topVendorsData.map(v => v.spend || 0).reverse(), label: { show: true, position: 'right', formatter: (p) => formatCurrency(p.value), fontSize: 9 } }] }, true);

                     // Category Treemap (Keep robust mapping)
                      if (chartInstances.categoryTreemapChart) chartInstances.categoryTreemapChart.setOption({ /* ... */ tooltip: { formatter: (info) => info.name ? `${info.name}: ${formatCurrency(info.value)} (${(info.percent * 100).toFixed(1)}%)` : '' }, series: [{ name: 'Spend Distribution', type: 'treemap', roam: false, nodeClick: 'link', label: { show: true, formatter: params => `${params.name}\n${formatCurrency(params.value)}`, fontSize: 10 }, upperLabel: { show: true, height: 20, formatter: '{b}', color: '#fff' }, itemStyle: { borderColor: '#fff', borderWidth: 1, gapWidth: 1 }, levels: [ { itemStyle: { borderColor: '#777', borderWidth: 0, gapWidth: 1 }, upperLabel: { show: false } }, { itemStyle: { borderColor: '#555', borderWidth: 2, gapWidth: 1 }, emphasis: { itemStyle: { borderColor: '#ddd' } } }], data: spendByCategoryAgg.map(d => ({ name: d.category || 'Unknown', value: d.spend || 0 })) }] }, true);

                     // Category Radar (Keep robust calculation and mapping)
                      const topNCategoriesRadar = 5; const radarCategoriesData = spendByCategoryAgg.slice(0, topNCategoriesRadar); const radarIndicator = [ { name: 'Spend', max: radarCategoriesData.length > 0 ? Math.max(10000, ...radarCategoriesData.map(c => c.spend || 0)) : 10000 }, { name: '# Vendors', max: radarCategoriesData.length > 0 ? Math.max(5, ...radarCategoriesData.map(c => new Set(filteredData.filter(i=>i.category===c.category).map(i=>i.vendor)).size)) : 5 }, { name: 'Avg Spend/PO', max: radarCategoriesData.length > 0 ? Math.max(1000, ...radarCategoriesData.map(c => (c.poCount || 0) > 0 ? (c.spend || 0) / c.poCount : 0)) : 1000 }, { name: '# POs', max: radarCategoriesData.length > 0 ? Math.max(10, ...radarCategoriesData.map(c => c.poCount || 0)) : 10 } ]; const radarSeriesData = radarCategoriesData.map(cat => { const catData = filteredData.filter(item => item.category === cat.category); const numVendors = new Set(catData.map(item => item.vendor)).size; const totalPOs = cat.poCount || 0; const avgSpend = totalPOs > 0 ? (cat.spend || 0) / totalPOs : 0; return { name: cat.category || 'Unknown', value: [cat.spend || 0, numVendors, avgSpend, totalPOs] }; }); if (chartInstances.categoryRadarChart) chartInstances.categoryRadarChart.setOption({ /* ... */ tooltip: { trigger: 'item' }, legend: { data: radarCategoriesData.map(c => c.category || 'Unknown'), bottom: 5, type: 'scroll' }, radar: { indicator: radarIndicator, shape: 'circle', center: ['50%','50%'], radius: '65%' }, series: [{ name: 'Category Comparison', type: 'radar', data: radarSeriesData }] }, true);

                     // Category -> Vendor Sunburst (Keep robust mapping)
                      const sunburstData = spendByCategoryAgg.map(cat => { const vendorsInCategory = aggregateData(filteredData.filter(item => item.category === cat.category), 'vendor') || []; return { name: cat.category || 'Unknown', value: cat.spend || 0, children: vendorsInCategory.sort((a,b) => (b.spend || 0) - (a.spend || 0)).slice(0, 8).map(v => ({ name: v.vendor || 'Unknown', value: v.spend || 0 })) }; }).sort((a,b) => (b.value || 0) - (a.value || 0)).slice(0, 10); if (chartInstances.categoryVendorSunburst) chartInstances.categoryVendorSunburst.setOption({ /* ... */ tooltip: { formatter: (p) => p.name ? `${p.name}: ${formatCurrency(p.value)}` : ''}, series: [{ type: 'sunburst', data: sunburstData, radius: [0, '90%'], label: { rotate: 'radial', fontSize: 9 }, levels: [{}, { r0: '10%', r: '65%', itemStyle: { borderWidth: 1 }, label: { rotate: 'tangential', align: 'right' } }, { r0: '65%', r: '95%', label: { align: 'right', fontSize: 8 }, itemStyle: { borderWidth: 1} }], itemStyle: { borderWidth: 1, borderColor: '#fff', borderRadius: 3 } }] }, true);

                      // Category -> Vendor Sankey (Keep robust filtering and mapping)
                      const topCategoriesForSankey = spendByCategoryAgg.slice(0, 8).map(c => c.category); const topVendorsForSankey = spendByVendorAgg.slice(0, 12).map(v => v.vendor); const sankeyNodesSet = new Set(); const sankeyLinks = {}; let validSankeyDataExists = false; filteredData.forEach(item => { if(!item.category || !item.vendor) return; if (topCategoriesForSankey.includes(item.category) && topVendorsForSankey.includes(item.vendor)) { sankeyNodesSet.add(item.category); sankeyNodesSet.add(item.vendor); const linkKey = `${item.category} -> ${item.vendor}`; sankeyLinks[linkKey] = (sankeyLinks[linkKey] || 0) + (item.spend || 0); validSankeyDataExists = true;}}); let finalSankeyNodes = [], finalSankeyLinks = []; if(validSankeyDataExists) { finalSankeyNodes = [...new Set([...topCategoriesForSankey, ...topVendorsForSankey])].map(name => ({ name })); finalSankeyLinks = Object.entries(sankeyLinks).map(([key, value]) => { const [source, target] = key.split(' -> '); return { source, target, value }; }).filter(link => link.value > 0).sort((a,b) => b.value - a.value); } if (chartInstances.categoryVendorSankey) chartInstances.categoryVendorSankey.setOption({ /* ... */ tooltip: { trigger: 'item', triggerOn: 'mousemove', formatter: (p) => { if(p.dataType === 'edge') return `${p.data.source} -> ${p.data.target}: ${formatCurrency(p.value)}`; if(p.dataType === 'node') return `${p.name}: ${formatCurrency(p.value)}`; return ''; } }, series: [{ type: 'sankey', layout: 'none', emphasis: { focus: 'adjacency' }, nodeAlign: 'justify', data: finalSankeyNodes, links: finalSankeyLinks, lineStyle: { color: 'gradient', curveness: 0.5 }, label: { fontSize: 9 } }] }, true);

                      // Geo Map (Keep conditional update)
                     if (chartInstances.spendGeoMapChart && echarts.getMap('world')) { /* ... */ console.log("World map is registered. Updating Geo Map chart."); const mapData = spendByCountryAgg.map(c => ({ name: getCountryName(c.vendorCountry), value: c.spend || 0 })).filter(c => c.name && c.value > 0); const mapMaxSpend = mapData.length > 0 ? Math.max(100000, ...mapData.map(d=>d.value)) : 100000; chartInstances.spendGeoMapChart.setOption({ tooltip: { trigger: 'item', showDelay: 0, transitionDuration: 0.2, formatter: (params) => params.name ? `${params.name}: ${formatCurrency(params.value || 0)}` : 'No Data' }, visualMap: { left: 'right', min: 0, max: mapMaxSpend, inRange: { color: ['#d7f0f8', '#abd9e9', '#74add1', '#4575b4', '#313695'].reverse() }, text: ['High', 'Low'], calculable: true }, series: [{ name: 'Spend by Vendor Country', type: 'map', roam: true, map: 'world', nameProperty: 'name', emphasis: { label: { show: true }, itemStyle: { areaColor: '#f39c12' } }, data: mapData }] }, true); if (domElements.mapPlaceholder) domElements.mapPlaceholder.style.display = 'none'; } else if (chartInstances.spendGeoMapChart) { console.warn('Geo map skipped - "world" map data not registered yet.'); showMapPlaceholder('Map data loading or unavailable.'); }


                     // --- Update KPIs ---
                     console.log("Updating KPIs...");
                     domElements.kpiTotalSpend.textContent = formatCurrency(totalSpend); domElements.kpiTotalPOs.textContent = formatNumber(totalPOs); domElements.kpiTotalInvoices.textContent = formatNumber(totalInvoices); domElements.kpiActiveVendors.textContent = formatNumber(activeVendors); domElements.kpiAvgSpendPO.textContent = formatCurrency(avgSpendPO);

                     // --- Update Vendor Ranking Table ---
                     console.log("Updating table...");
                     domElements.vendorRankingTbody.innerHTML = ''; if (spendByVendorAgg.length > 0) { spendByVendorAgg.forEach(vendor => { const row = domElements.vendorRankingTbody.insertRow(); row.dataset.vendor = vendor.vendor; row.insertCell().textContent = vendor.vendor || 'N/A'; row.insertCell().textContent = vendor.vendorCountry || 'N/A'; row.insertCell().textContent = formatCurrency(vendor.spend, false); row.insertCell().textContent = formatNumber(vendor.poCount); const avg = (vendor.poCount || 0) > 0 ? (vendor.spend || 0) / vendor.poCount : 0; row.insertCell().textContent = formatCurrency(avg, false); if (currentFilters.vendor === vendor.vendor) row.classList.add('filtered'); }); } else { domElements.vendorRankingTbody.innerHTML = '<tr><td colspan="5">No vendor data for current filters.</td></tr>'; }

                     // --- Update Filter Info Display ---
                     let filterText = "Active Filters: "; const activeFilterList = [];
                     if (currentFilters.vendor) activeFilterList.push(`Vendor='${currentFilters.vendor}'`);
                     if (currentFilters.category) activeFilterList.push(`Category='${currentFilters.category}'`);
                     if (currentFilters.poType) { const poTypeDesc = poTypes[currentFilters.poType] || currentFilters.poType; activeFilterList.push(`PO Type='${poTypeDesc}'`); }
                     // ** NEW: Add date range to filter info **
                     if (currentFilters.startDate) activeFilterList.push(`Start='${currentFilters.startDate}'`);
                     if (currentFilters.endDate) activeFilterList.push(`End='${currentFilters.endDate}'`);
                     // ***************************************
                     domElements.filterInfoDiv.textContent = filterText + (activeFilterList.length > 0 ? activeFilterList.join(' | ') : 'None');

                 } catch (error) { displayError(`Failed to update dashboard visuals: ${error.message}`, error); }
                 finally { const endTime = performance.now(); console.log(`Dashboard update took ${ (endTime - startTime).toFixed(2) } ms`); }
            } // End of updateDashboard()


            // --- 6. Event Listeners ---
             console.log("Adding event listeners...");
             try {
                  // Add listeners for Bar, Treemap, Sunburst, PO Pie, Table
                  if (chartInstances.topVendorsChart) { chartInstances.topVendorsChart.on('click', function (params) { if (params.componentType === 'series' && params.seriesType === 'bar' && params.name) { console.log("Vendor chart clicked:", params.name); currentFilters.vendor = currentFilters.vendor === params.name ? null : params.name; updateDashboard(); } }); }
                  if (chartInstances.categoryTreemapChart) { chartInstances.categoryTreemapChart.on('click', function (params) { if (params.componentType === 'series' && params.seriesType === 'treemap' && params.name) { console.log("Category treemap clicked:", params.name); currentFilters.category = currentFilters.category === params.name ? null : params.name; updateDashboard(); } }); }
                  if (chartInstances.categoryVendorSunburst) { chartInstances.categoryVendorSunburst.on('click', function (params) { if (params.componentType === 'series' && params.seriesType === 'sunburst' && params.data && params.treePathInfo && params.treePathInfo.length === 2) { const clickedCategory = params.name; console.log("Sunburst category clicked:", clickedCategory); currentFilters.category = currentFilters.category === clickedCategory ? null : clickedCategory; updateDashboard(); } }); }
                  if (chartInstances.spendByPOTypeChart) { chartInstances.spendByPOTypeChart.on('click', function (params) { if (params.componentType === 'series' && params.seriesType === 'pie' && params.name) { const clickedDesc = params.name; const clickedKey = getPOTypeKey(clickedDesc); console.log(`PO Type pie clicked: Desc='${clickedDesc}', Key='${clickedKey}'`); if (clickedKey) { currentFilters.poType = currentFilters.poType === clickedKey ? null : clickedKey; updateDashboard(); } else { console.warn("Could not find PO Type key for description:", clickedDesc); } } }); }
                  domElements.vendorRankingTbody.addEventListener('click', function(event) { const clickedRow = event.target.closest('tr'); if (clickedRow && clickedRow.dataset.vendor) { const clickedVendor = clickedRow.dataset.vendor; console.log("Vendor table row clicked:", clickedVendor); currentFilters.vendor = currentFilters.vendor === clickedVendor ? null : clickedVendor; updateDashboard(); } });

                  // ** NEW: Date Input Listeners **
                  if (domElements.dateStartInput && domElements.dateEndInput) {
                        domElements.dateStartInput.addEventListener('change', (event) => {
                            currentFilters.startDate = event.target.value || null; // Treat empty as null
                            // Optional: Basic validation (e.g., end date shouldn't be before start date)
                            if (currentFilters.endDate && currentFilters.startDate > currentFilters.endDate) {
                                 console.warn("Start date is after end date. Clearing end date.");
                                 currentFilters.endDate = null;
                                 domElements.dateEndInput.value = ''; // Clear visually too
                            }
                            console.log("Date Start changed:", currentFilters.startDate);
                            updateDashboard();
                        });
                        domElements.dateEndInput.addEventListener('change', (event) => {
                            currentFilters.endDate = event.target.value || null; // Treat empty as null
                             // Optional: Basic validation
                             if (currentFilters.startDate && currentFilters.endDate < currentFilters.startDate) {
                                 console.warn("End date is before start date. Clearing start date.");
                                 currentFilters.startDate = null;
                                 domElements.dateStartInput.value = ''; // Clear visually too
                             }
                            console.log("Date End changed:", currentFilters.endDate);
                            updateDashboard();
                        });
                  } else { console.error("Date input elements not found for listeners!"); }
                  // ******************************

                  // Reset Button
                  domElements.resetButton.addEventListener('click', function() { console.log("Reset filters clicked");
                      currentFilters.vendor = null; currentFilters.category = null; currentFilters.poType = null;
                      // ** NEW: Reset date filters **
                      currentFilters.startDate = null; currentFilters.endDate = null;
                      if (domElements.dateStartInput) domElements.dateStartInput.value = ''; // Clear input visually
                      if (domElements.dateEndInput) domElements.dateEndInput.value = '';   // Clear input visually
                      // ***************************
                      updateDashboard();
                  });

                  // Resize
                  let resizeTimeout; window.addEventListener('resize', function() { clearTimeout(resizeTimeout); resizeTimeout = setTimeout(() => { console.log("Window resized, resizing charts..."); for (const id in chartInstances) { if (chartInstances[id]) { try { chartInstances[id].resize(); } catch (e) { console.error(`Error resizing ${id}:`, e); } } } }, 150); });
             } catch (error) { displayError("Failed to set up event listeners", error); }

            // --- 7. Initial Load ---
            console.log("Performing initial dashboard load...");
            updateDashboard();
            console.log("Initial dashboard load complete.");

        }); // End DOMContentLoaded
    </script>
</body>
</html>